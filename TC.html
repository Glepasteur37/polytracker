<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIS2 CyberCheck - Diagnostic de Conformit√© B2B</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Configuration de la palette et de la police */
        :root {
            --color-primary: #1e293b; /* Slate-900 */
            --color-accent: #2563eb; /* Blue-600 */
            --color-alert: #ef4444; /* Red-500 */
        }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--color-primary);
            color: white;
        }
        /* Style pour les cartes de s√©lection (Phase 1 & 2) */
        .card-select {
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .card-select:hover {
            border-color: #374151; /* Gray-700 */
        }
        .card-select.selected {
            border-color: var(--color-accent);
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-8">

    <header class="w-full max-w-2xl py-4 flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold text-white flex items-center">
            <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944c-1.25.17-2.484.5-3.67.986M5.632 8.79a9.965 9.965 0 00-1.89 3.031A12.001 12.001 0 0012 21c1.884 0 3.666-.356 5.344-1.002M4 15h16M4 18h16M4 21h16"></path></svg>
            CyberCheck
        </h1>
        <div id="progress-container" class="w-2/3 h-2 bg-slate-700 rounded-full">
            <div id="progress-bar" class="h-2 bg-blue-600 rounded-full transition-all duration-500" style="width: 0%;"></div>
        </div>
    </header>

    <main class="w-full max-w-2xl bg-slate-800 rounded-lg shadow-2xl p-6 sm:p-10">

        <div id="wizard-steps" class="space-y-6">

            <div id="step-0" class="step">
                <h2 class="text-4xl font-extrabold text-blue-400 mb-4">Directive NIS2 : Votre entreprise est-elle pr√™te pour l'amende ?</h2>
                <p class="text-xl text-slate-300 mb-8">Diagnostic de vuln√©rabilit√© et d'√©ligibilit√© en 2 minutes. Rapport d'action PDF offert √† la fin.</p>
                <div class="flex justify-center">
                    <button onclick="nextStep(1)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-xl transition duration-300 shadow-lg">
                        Lancer le Scan de Conformit√©
                    </button>
                </div>
            </div>

            <div id="step-1" class="step hidden">
                <h3 class="text-2xl font-semibold mb-6">Phase 1/3 : Profil de votre organisation</h3>
                <div class="space-y-8">
                    <div data-q="effectif">
                        <p class="text-lg font-medium mb-3">1. Quel est l'effectif de votre entreprise ?</p>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center" data-value="<50">PME (< 50)</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center" data-value="50-249">ETI (50-249)</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center" data-value=">=250">Grand Groupe (‚â• 250)</div>
                        </div>
                    </div>
                    <div data-q="ca">
                        <p class="text-lg font-medium mb-3">2. Quel est votre Chiffre d'Affaires annuel ?</p>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center" data-value="<10M">Moins de 10M‚Ç¨</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center" data-value="10M-50M">10M‚Ç¨ √† 50M‚Ç¨</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center" data-value=">50M">Plus de 50M‚Ç¨</div>
                        </div>
                    </div>
                    <div data-q="secteur">
                        <p class="text-lg font-medium mb-3">3. Votre secteur d'activit√© est-il consid√©r√© comme critique ?</p>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center text-sm" data-value="Energie">√ânergie</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center text-sm" data-value="Transport">Transport</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center text-sm" data-value="Sante/Finance">Sant√©/Finance</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center text-sm" data-value="Numerique/Data">Num√©rique/Data</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center text-sm" data-value="Industrie">Industrie</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center text-sm" data-value="Eau/Dechet">Eau/D√©chets</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center text-sm" data-value="Autre">Autre (Non critique)</div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button onclick="nextStep(2)" id="btn-step-1" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 opacity-50 cursor-not-allowed" disabled>
                        Continuer
                    </button>
                </div>
            </div>

            <div id="step-2" class="step hidden">
                <h3 class="text-2xl font-semibold mb-6">Phase 2/3 : Maturit√© & Qualification Cyber</h3>
                <div class="space-y-8">
                    <div data-q="rto">
                        <p class="text-lg font-medium mb-3">4. Si vos serveurs sont crypt√©s par un ransomware, en combien de temps pouvez-vous restaurer l'activit√© ?</p>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center" data-value="<4h">Moins de 4 heures</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center" data-value="24h-48h">24h √† 48 heures</div>
                            <div class="card-select p-4 rounded-lg bg-red-800/50 text-center" data-value="PasDePlan">Je ne sais pas / Pas de plan fiable</div>
                        </div>
                    </div>
                    <div data-q="gestion_cyber">
                        <p class="text-lg font-medium mb-3">5. Qui g√®re la cybers√©curit√© de votre entreprise aujourd'hui ?</p>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center" data-value="DSI_Interne">Service DSI Interne</div>
                            <div class="card-select p-4 rounded-lg bg-slate-700 text-center" data-value="MSP_Externe">Un prestataire externe (MSP)</div>
                            <div class="card-select p-4 rounded-lg bg-blue-800/50 text-center" data-value="Dirigeant_NonDedicace">Personne de d√©di√© / Le dirigeant</div>
                        </div>
                    </div>
                    <div data-q="mfa">
                        <p class="text-lg font-medium mb-3">6. Avez-vous mis en place l'Authentification Multifacteur (MFA) sur tous les acc√®s distants ?</p>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="card-select p-4 rounded-lg bg-green-700/50 text-center" data-value="Oui">Oui, partout</div>
                            <div class="card-select p-4 rounded-lg bg-yellow-700/50 text-center" data-value="Partiel">Partiellement</div>
                            <div class="card-select p-4 rounded-lg bg-red-800/50 text-center" data-value="Non">Non, mot de passe simple</div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button onclick="nextStep(3)" id="btn-step-2" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 opacity-50 cursor-not-allowed" disabled>
                        Voir les R√©sultats
                    </button>
                </div>
            </div>

            <div id="step-3" class="step hidden">
                <div id="loading-animation" class="text-center space-y-4">
                    <svg class="animate-spin h-10 w-10 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p id="loading-text" class="text-xl">Analyse des r√©ponses en cours...</p>
                </div>

                <div id="lead-gate" class="hidden text-center">
                    <h4 class="text-3xl font-extrabold text-red-500 mb-4">R√âSULTAT : VOTRE ENTREPRISE PR√âSENTE UN RISQUE √âLEV√â</h4>
                    <p class="text-xl text-slate-300 mb-8">Pour d√©bloquer votre Score de Vuln√©rabilit√© d√©taill√© et recevoir votre Plan d'Action NIS2 (PDF) par e-mail, confirmez l'envoi :</p>

                    <form id="lead-form" class="space-y-4">
                        <input type="email" id="email" placeholder="Email Professionnel (ex: @monentreprise.com)" required class="w-full p-3 rounded bg-slate-700 border border-slate-600 focus:ring-blue-600 focus:border-blue-600 text-white">
                        <input type="tel" id="phone" placeholder="Num√©ro de t√©l√©phone mobile" required class="w-full p-3 rounded bg-slate-700 border border-slate-600 focus:ring-blue-600 focus:border-blue-600 text-white">
                        <select id="fonction" required class="w-full p-3 rounded bg-slate-700 border border-slate-600 focus:ring-blue-600 focus:border-blue-600 text-white">
                            <option value="">-- Votre Fonction --</option>
                            <option value="PDG">PDG / G√©rant</option>
                            <option value="DSI">DSI / RSI</option>
                            <option value="DAF">DAF / Directeur Administratif</option>
                            <option value="Autre">Autre</option>
                        </select>
                        <div class="flex items-start pt-2">
                            <input type="checkbox" id="consent" required class="mt-1 mr-2 rounded text-blue-600 focus:ring-blue-500">
                            <label for="consent" class="text-sm text-slate-400">
                                J'ai lu et j'accepte les 
                                <a href="#politique-confidentialite" target="_blank" class="text-blue-400 hover:text-blue-300 underline font-semibold">
                                    Conditions G√©n√©rales d'Utilisation et la Politique de Confidentialit√©
                                </a>. (Obligatoire)
                            </label>
                        </div>
                        <p id="validation-error" class="text-red-400 text-sm hidden">Veuillez v√©rifier les informations (email pro requis).</p>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 mt-4">
                            Voir mon R√©sultat & Recevoir le PDF
                        </button>
                    </form>
                </div>
            </div>

            <div id="step-4" class="step hidden">
                <h3 class="text-3xl font-bold mb-6 text-blue-400">Votre Rapport de Conformit√© (Synth√®se)</h3>
                
                <div class="bg-slate-700 p-6 rounded-lg space-y-4">
                    <div class="flex justify-between items-center border-b border-slate-600 pb-3">
                        <span class="text-xl font-medium">Statut d'√âligibilit√© NIS2 Probable :</span>
                        <span id="nis2-status" class="text-2xl font-extrabold text-orange-400">Entit√© Importante</span>
                    </div>

                    <div class="pt-4">
                        <p class="text-xl font-medium mb-2">Score de Vuln√©rabilit√© (100 = Z√©ro risque) :</p>
                        <div id="score-gauge" class="w-full h-8 bg-slate-600 rounded-full overflow-hidden">
                            <div id="score-bar" class="h-8 rounded-full transition-all duration-700 flex items-center justify-end pr-3 font-bold" style="width: 35%; background-color: var(--color-alert);">
                                <span id="score-text">35 / 100</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h4 class="text-2xl font-semibold mb-3">Recommandations & Prochaines √âtapes :</h4>
                    <ul id="recommendations" class="list-disc list-inside space-y-2 text-slate-300 pl-4">
                        <li>Votre rapport PDF d√©taill√© a √©t√© envoy√© √† l'adresse <span id="final-email" class="font-bold text-blue-400"></span>.</li>
                        <li class="text-red-400 font-bold">URGENCE : Activation imm√©diate du MFA. Le score est critique sur ce point.</li>
                        <li id="recommendation-rto">Audit de votre Plan de Reprise d'Activit√© (PRA) et test des sauvegardes d√©connect√©es.</li>
                    </ul>
                </div>
            </div>

        </div>
    </main>

    <section id="politique-confidentialite" class="w-full max-w-2xl mt-12 p-6 bg-slate-800 rounded-lg text-sm text-slate-400">
        <h2 class="text-xl font-bold mb-4 text-blue-400">Politique de Confidentialit√© et Conditions G√©n√©rales d'Utilisation</h2>
        <div class="space-y-6">
            <h2 class="text-2xl font-extrabold text-blue-400 border-b border-slate-700 pb-2">
                POLITIQUE DE CONFIDENTIALIT√â (RGPD)
            </h2>
            <p class="text-sm">
                **Date d'entr√©e en vigueur :** <span class="text-white font-semibold">[Date du lancement de votre outil]</span>
            </p>
            <h3 class="text-xl font-bold text-white pt-2">1. Identit√© du Responsable du Traitement</h3>
            <p class="text-sm leading-relaxed">
                La soci√©t√© <span class="text-white font-semibold">[NOM DE VOTRE SOCI√âT√â]</span>, dont le si√®ge social est situ√© au <span class="text-white font-semibold">[ADRESSE]</span>, immatricul√©e sous le num√©ro <span class="text-white font-semibold">[SIREN/SIRET]</span>, est le responsable du traitement des donn√©es collect√©es via le questionnaire "CyberCheck" (ci-apr√®s, le "Service").
            </p>
            <h3 class="text-xl font-bold text-white pt-2">2. Donn√©es Personnelles Collect√©es</h3>
            <p class="text-sm leading-relaxed">
                Nous collectons les donn√©es suivantes (ci-apr√®s les "Donn√©es") :
            </p>
            <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                <li><span class="font-semibold">Donn√©es d'identification et de contact :</span> Adresse e-mail professionnelle, num√©ro de t√©l√©phone mobile.</li>
                <li><span class="font-semibold">Donn√©es professionnelles :</span> Fonction/Poste, nom de l'entreprise, effectif, chiffre d'affaires, secteur d'activit√© (issues du questionnaire).</li>
                <li><span class="font-semibold">Donn√©es de diagnostic :</span> R√©ponses au questionnaire NIS2 et score de vuln√©rabilit√© calcul√©.</li>
            </ul>
            <h3 class="text-xl font-bold text-white pt-2">3. Finalit√©s et Base L√©gale du Traitement</h3>
            <p class="text-sm leading-relaxed">
                Le traitement de vos Donn√©es est fond√© sur votre <span class="font-semibold text-blue-400">Consentement</span> explicite (Article 6.1 a du RGPD), donn√© via la case √† cocher obligatoire.
            </p>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left rounded-lg overflow-hidden border border-slate-700">
                    <thead class="text-xs text-white uppercase bg-slate-700">
                        <tr>
                            <th scope="col" class="py-3 px-6">Finalit√© du Traitement</th>
                            <th scope="col" class="py-3 px-6">Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="bg-slate-800 border-b border-slate-700">
                            <td class="py-3 px-6 font-medium text-white">A. Envoi du Diagnostic NIS2</td>
                            <td class="py-3 px-6">Fournir le rapport d'audit (PDF) et les recommandations personnalis√©es suite au questionnaire.</td>
                        </tr>
                        <tr class="bg-slate-800 border-b border-slate-700">
                            <td class="py-3 px-6 font-medium text-white">B. Prospection Commerciale et Revente</td>
                            <td class="py-3 px-6 text-red-400 font-bold">
                                Partager ou revendre vos Donn√©es √† des tiers, y compris des courtiers, des partenaires commerciaux sp√©cialis√©s en cybers√©curit√© ou des agences de marketing B2B, pour leurs propres fins de prospection commerciale.
                            </td>
                        </tr>
                        <tr class="bg-slate-800">
                            <td class="py-3 px-6 font-medium text-white">C. Am√©lioration du Service</td>
                            <td class="py-3 px-6">Analyser les tendances de conformit√© et am√©liorer la qualit√© de notre outil et de nos offres.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <h3 class="text-xl font-bold text-white pt-2">4. Destinataires et Transfert des Donn√©es (Revente)</h3>
            <p class="text-sm leading-relaxed">
                Vos Donn√©es sont susceptibles d'√™tre communiqu√©es √† :
            </p>
            <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                <li>Nos services internes (marketing, commercial).</li>
                <li>
                    <span class="font-semibold text-red-400">Des Partenaires Commerciaux Tiers :</span> Conform√©ment √† la finalit√© B (Prospection Commerciale et Revente), nous transmettons vos Donn√©es aux **courtiers en donn√©es, aux soci√©t√©s de conseil en cybers√©curit√© (MSP) et √† d'autres partenaires commerciaux** souhaitant vous contacter pour des services de mise en conformit√© ou des solutions de s√©curit√©. Ces partenaires deviennent eux-m√™mes responsables de traitement pour leur prospection.
                </li>
                <li>Des sous-traitants techniques (h√©bergement, CRM, Webhooks Make.com).</li>
            </ul>
            <p class="text-xs leading-relaxed mt-3">
                Nous ne transf√©rons pas vos Donn√©es en dehors de l'Union Europ√©enne (UE) ou de l'Espace √âconomique Europ√©en (EEE), sauf si un partenaire tiers s'y engage contractuellement et garantit le respect des Clauses Contractuelles Types (CCT) de la Commission Europ√©enne.
            </p>
            <h3 class="text-xl font-bold text-white pt-2">5. Dur√©e de Conservation</h3>
            <p class="text-sm leading-relaxed">
                Vos Donn√©es sont conserv√©es pendant la dur√©e n√©cessaire √† la r√©alisation des finalit√©s d√©crites ci-dessus. Pour la finalit√© de Prospection Commerciale et de Revente (Finalit√© B), les Donn√©es sont conserv√©es pendant <span class="font-semibold text-white">trois (3) ans</span> √† compter de la collecte ou du dernier contact entrant, puis supprim√©es ou anonymis√©es, sauf demande d'effacement de votre part.
            </p>
            <h3 class="text-xl font-bold text-white pt-2">6. Vos Droits RGPD</h3>
            <p class="text-sm leading-relaxed">
                Conform√©ment √† la r√©glementation, vous disposez des droits suivants concernant vos Donn√©es :
            </p>
            <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                <li><span class="font-semibold">Droit d'acc√®s</span> (savoir quelles donn√©es nous traitons).</li>
                <li><span class="font-semibold">Droit de rectification</span> (mettre √† jour vos donn√©es).</li>
                <li><span class="font-semibold">Droit √† l'effacement</span> (demander l'oubli de vos donn√©es, notamment pour la finalit√© B).</li>
                <li>Droit √† la limitation du traitement.</li>
                <li><span class="font-semibold">Droit d'opposition</span> au traitement de vos donn√©es, y compris la prospection commerciale.</li>
                <li>Droit √† la portabilit√© de vos donn√©es.</li>
                <li><span class="font-semibold">Droit de retirer votre consentement</span> √† tout moment, sans que cela n'affecte la lic√©it√© du traitement fond√© sur le consentement effectu√© avant ce retrait.</li>
            </ul>
            <p class="text-sm leading-relaxed mt-4">
                Pour exercer ces droits, veuillez nous contacter √† l'adresse e-mail suivante : <span class="font-semibold text-blue-400">[VOTRE ADRESSE E-MAIL DE CONTACT RGPD]</span>.
            </p>
            <p class="text-xs leading-relaxed pt-2 border-t border-slate-700 mt-4">
                Vous avez √©galement le droit d'introduire une r√©clamation aupr√®s de la CNIL (Commission Nationale de l'Informatique et des Libert√©s) en France.
            </p>
        </div>
        <p class="mt-4 text-xs text-red-400">Note: Ce texte est une √©bauche et doit √™tre valid√© par un conseiller juridique.</p>
    </section>

    <script>
        // --- SUPABASE CONFIGURATION ---
        // üü¢ CONFIGURATION MISE √Ä JOUR AVEC VOS CL√âS
        const SUPABASE_URL = 'https://tojrymqodbivxpicviff.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_3QUnx9VckCcxLDXfJ3Dmzg_00hxvi8t';
        const TABLE_NAME = 'leads_nis2'; // Nom de la table que vous avez cr√©√©

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // ------------------------------

        // √âtat de l'application
        let currentStep = 0;
        const totalSteps = 4; // Total des phases (0 √† 4)
        const responses = {}; // Stocke les r√©ponses des utilisateurs

        // Emails gratuits √† rejeter pour la qualification B2B
        const freeEmailDomains = [
            '@gmail.com', '@hotmail.com', '@outlook.com', '@yahoo.com', 
            '@orange.fr', '@laposte.net', '@free.fr', '@aol.com'
        ];

        // --- Fonctions de Navigation et d'UX ---
        
        function updateProgress() {
            const percentage = (currentStep / (totalSteps - 1)) * 100;
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
        }

        function showStep(stepIndex) {
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.toggle('hidden', index !== stepIndex);
            });
            currentStep = stepIndex;
            updateProgress();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function checkStepCompletion(stepIndex) {
            let completed = true;
            const stepDiv = document.getElementById(`step-${stepIndex}`);
            if (!stepDiv) return false;

            // Pour les √©tapes 1 et 2 (questions √† cartes)
            stepDiv.querySelectorAll('[data-q]').forEach(qDiv => {
                const qName = qDiv.getAttribute('data-q');
                if (!responses[qName]) {
                    completed = false;
                }
            });

            const nextButtonId = `btn-step-${stepIndex}`;
            const nextButton = document.getElementById(nextButtonId);
            if (nextButton) {
                nextButton.disabled = !completed;
                nextButton.classList.toggle('opacity-50', !completed);
                nextButton.classList.toggle('cursor-not-allowed', !completed);
            }
            return completed;
        }

        function nextStep(targetStep) {
            if (targetStep === 3) {
                // Passage √† la Gate : simuler le chargement
                showStep(3);
                document.getElementById('loading-animation').classList.remove('hidden');
                document.getElementById('lead-gate').classList.add('hidden');
                document.getElementById('loading-text').textContent = "Analyse des r√©ponses en cours...";
                
                // Animation de chargement
                setTimeout(() => {
                    document.getElementById('loading-text').textContent = "Calcul du score de vuln√©rabilit√©...";
                }, 1000);
                setTimeout(() => {
                    document.getElementById('loading-text').textContent = "G√©n√©ration du rapport...";
                }, 2000);
                
                // Afficher la Gate apr√®s 3 secondes
                setTimeout(() => {
                    document.getElementById('loading-animation').classList.add('hidden');
                    document.getElementById('lead-gate').classList.remove('hidden');
                }, 3000);

            } else {
                showStep(targetStep);
            }
        }


        // --- Fonctions de Scoring et de Logique M√©tier ---

        function calculateScoreAndStatus() {
            let score = 100; // Commence √† 100
            let isEssential = false;
            let isImportant = false;
            let recommendations = [];

            // LOGIQUE NIS2 (Phase 1)
            const effectif = responses.effectif;
            const ca = responses.ca;
            const secteur = responses.secteur;
            const isCriticalSector = secteur !== 'Autre';

            if (isCriticalSector) {
                if (effectif === '>=250' || ca === '>50M') {
                    isEssential = true;
                } else if (effectif === '50-249' || ca === '10M-50M') {
                    isImportant = true;
                }
            }
            // Si non essentiel/important, on reste sur "Vigilance Requise" pour le lead gen
            let nis2StatusText = "Vigilance Requise (Hors champ)";
            if (isEssential) {
                nis2StatusText = "Entit√© Essentielle (Probabilit√© 95%)";
            } else if (isImportant) {
                nis2StatusText = "Entit√© Importante (Probabilit√© 90%)";
            }

            // LOGIQUE DE VULN√âRABILIT√â (Phase 2)
            // Q4: RTO Ransomware -> PasDePlan est critique
            if (responses.rto === 'PasDePlan') {
                score -= 30;
                recommendations.push("Audit de votre Plan de Reprise d'Activit√© (PRA) et test des sauvegardes d√©connect√©es.");
            } else if (responses.rto === '24h-48h') {
                score -= 10;
            }

            // Q5: Qui g√®re la Cyber -> Dirigeant_NonDedicace est critique/Lead Gold
            if (responses.gestion_cyber === 'Dirigeant_NonDedicace') {
                score -= 25;
                recommendations.push("Besoin urgent de d√©l√©guer la s√©curit√© √† un expert (interne ou MSP).");
            } else if (responses.gestion_cyber === 'MSP_Externe') {
                recommendations.push("V√©rifiez l'alignement de votre MSP actuel avec les nouvelles exigences NIS2.");
            }

            // Q6: MFA -> Non est critique
            if (responses.mfa === 'Non') {
                score -= 35;
                recommendations.push("URGENCE : Activation imm√©diate de l'Authentification Multifacteur (MFA). Risque critique.");
            } else if (responses.mfa === 'Partiel') {
                score -= 10;
                recommendations.push("√âtendre le MFA √† *tous* les acc√®s distants, y compris les VPN et les outils cloud.");
            }

            // Assurer que le score ne soit pas n√©gatif et toujours inf√©rieur √† 70 si le lead a franchi la phase 3
            score = Math.max(10, Math.min(score, 70));

            return {
                finalScore: score,
                status: nis2StatusText,
                recommendations: recommendations
            };
        }

        // üü¢ FONCTION : ENVOI √Ä SUPABASE
        async function sendToSupabase(payload) {
            try {
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .insert([payload]);

                if (error) {
                    console.error("‚ùå ERREUR SUPABASE:", error);
                    alert("Erreur lors de l'enregistrement des donn√©es. Veuillez r√©essayer. (V√©rifiez la RLS)");
                    return false;
                } else {
                    console.log("‚úÖ LEAD ENREGISTR√â DANS SUPABASE:", data);
                    return true;
                }
            } catch (e) {
                console.error("‚ùå ERREUR CATCH SUPABASE:", e);
                return false;
            }
        }

        async function displayResults(email, phone, fonction) {
            const results = calculateScoreAndStatus();
            
            // 1. Cr√©ation du Payload
            const leadPayload = {
                email: email,
                phone: phone,
                fonction: fonction,
                // Le reste des donn√©es du questionnaire est stock√© dans un champ JSONB
                company_details: {
                    questionnaire_responses: responses,
                    analysis: {
                        nis2_status: results.status,
                        vulnerability_score: results.finalScore
                    }
                }
            };
            
            // 2. Envoi √† Supabase
            const success = await sendToSupabase(leadPayload);

            if (!success) {
                // Si l'envoi √©choue, on peut arr√™ter ici ou afficher un message d'erreur
                return; 
            }

            // 3. Mise √† jour du Dashboard (uniquement si l'envoi r√©ussit)
            document.getElementById('nis2-status').textContent = results.status;
            
            const scoreBar = document.getElementById('score-bar');
            const scoreText = document.getElementById('score-text');
            const finalEmail = document.getElementById('final-email');
            const recommendationsList = document.getElementById('recommendations');
            
            const scorePercentage = results.finalScore;
            scoreBar.style.width = `${scorePercentage}%`;
            scoreText.textContent = `${scorePercentage} / 100`;
            finalEmail.textContent = email;

            // Couleur de la jauge
            let barColor = 'var(--color-alert)';
            if (scorePercentage > 60) {
                barColor = 'rgb(34 197 94)'; // Green-500
            } else if (scorePercentage > 35) {
                barColor = 'rgb(253 186 116)'; // Amber-400
            }
            scoreBar.style.backgroundColor = barColor;

            // Mise √† jour des recommandations
            recommendationsList.innerHTML = '';
            recommendationsList.innerHTML = `<li>Votre rapport PDF d√©taill√© a √©t√© envoy√© √† l'adresse <span class="font-bold text-blue-400">${email}</span>.</li>`;
            results.recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recommendationsList.appendChild(li);
            });
            
            showStep(4);
        }

        // --- Initialisation des Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Listeners pour les cartes de s√©lection (Phase 1 & 2)
            document.querySelectorAll('.card-select').forEach(card => {
                card.addEventListener('click', function() {
                    const qDiv = this.closest('[data-q]');
                    const qName = qDiv.getAttribute('data-q');
                    const value = this.getAttribute('data-value');

                    // D√©s√©lectionner toutes les cartes de cette question
                    qDiv.querySelectorAll('.card-select').forEach(c => c.classList.remove('selected'));
                    
                    // S√©lectionner la carte cliqu√©e
                    this.classList.add('selected');
                    
                    // Stocker la r√©ponse
                    responses[qName] = value;

                    // V√©rifier la compl√©tion de l'√©tape
                    if (qName === 'secteur') {
                        checkStepCompletion(1);
                    }
                    if (qName === 'mfa') {
                        checkStepCompletion(2);
                    }
                });
            });

            // 2. Listener pour le Formulaire de Lead (Phase 3)
            const leadForm = document.getElementById('lead-form');
            leadForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const emailInput = document.getElementById('email');
                const email = emailInput.value.toLowerCase().trim();
                const phone = document.getElementById('phone').value.trim();
                const fonction = document.getElementById('fonction').value;
                const errorDiv = document.getElementById('validation-error');
                
                // Validation de l'email B2B
                const isFreeEmail = freeEmailDomains.some(domain => email.endsWith(domain));

                if (isFreeEmail) {
                    errorDiv.textContent = "Veuillez utiliser une adresse e-mail professionnelle (les e-mails gratuits sont rejet√©s).";
                    errorDiv.classList.remove('hidden');
                    emailInput.focus();
                    return;
                }

                errorDiv.classList.add('hidden');
                
                // Si la validation passe, envoyer les donn√©es et afficher les r√©sultats
                displayResults(email, phone, fonction);
            });

            // Initialiser l'affichage sur la premi√®re √©tape
            showStep(0);
        });
    </script>
</body>
</html>